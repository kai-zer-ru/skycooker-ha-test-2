#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ Bluetooth —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ R4S
"""

import asyncio
import sys
import time
from bleak import BleakClient

async def scan_characteristics():
    """–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞"""
    address = 'DA:D8:9F:9E:0B:4C'
    
    print(f"üîç –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É: {address}")
    
    # –ü–æ–ø—Ä–æ–±—É–µ–º –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
    max_attempts = 5
    attempt = 0
    
    while attempt < max_attempts:
        try:
            print(f"–ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è {attempt + 1}/{max_attempts}...")
            async with BleakClient(address, timeout=10.0) as client:
                print('‚úÖ –£—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ')
                
                # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã
                services = client.services
                print(f'üì¶ –ù–∞–π–¥–µ–Ω–æ —Å–µ—Ä–≤–∏—Å–æ–≤: {len(list(services))}')
                
                # –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º —Å–µ—Ä–≤–∏—Å–∞–º
                for service in services:
                    print(f'\nüìã –°–µ—Ä–≤–∏—Å: {service.uuid}')
                    
                    # –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º —Å–µ—Ä–≤–∏—Å–∞
                    for char in service.characteristics:
                        print(f'  üîß –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞: {char.uuid}')
                        print(f'     Handle: {char.handle}')
                        print(f'     –§–ª–∞–≥–∏: {char.properties}')
                        
                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
                        if 'notify' in char.properties:
                            print(f'     üì¢ –≠–¢–û –•–ê–†–ê–ö–¢–ï–†–ò–°–¢–ò–ö–ê –î–õ–Ø –£–í–ï–î–û–ú–õ–ï–ù–ò–ô!')
                        
                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ –¥–ª—è –∑–∞–ø–∏—Å–∏
                        if 'write' in char.properties or 'write-without-response' in char.properties:
                            print(f'     ‚úèÔ∏è  –≠–¢–û –•–ê–†–ê–ö–¢–ï–†–ò–°–¢–ò–ö–ê –î–õ–Ø –ó–ê–ü–ò–°–ò!')
                        
                        print()
                
                print("‚úÖ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ")
                return True
                
        except Exception as e:
            print(f'‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: {e}')
            attempt += 1
            if attempt < max_attempts:
                print(f"–ñ–¥–µ–º 3 —Å–µ–∫—É–Ω–¥—ã –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–æ–π...")
                await asyncio.sleep(3)
    
    return False

if __name__ == "__main__":
    print("üöÄ –ó–∞–ø—É—Å–∫ —Å–∫–∞–Ω–µ—Ä–∞ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ R4S —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞")
    print("üí° –ï—Å–ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∑–∞–Ω—è—Ç–æ, —Å–∫—Ä–∏–ø—Ç –±—É–¥–µ—Ç –∂–¥–∞—Ç—å –∏ –ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞")
    
    success = asyncio.run(scan_characteristics())
    
    if success:
        print("\n‚úÖ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—à–ª–æ —É—Å–ø–µ—à–Ω–æ")
        print("üìã –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏ —Å–æ–æ–±—â–∏—Ç–µ –æ –Ω–∏—Ö")
    else:
        print("\n‚ùå –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å")
        print("üîß –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:")
        print("   - –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤–∫–ª—é—á–µ–Ω–æ –∏ –≤ —Ä–µ–∂–∏–º–µ —Å–æ–ø—Ä—è–∂–µ–Ω–∏—è")
        print("   - Bluetooth –∞–¥–∞–ø—Ç–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç")
        print("   - –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∑–æ–Ω–µ –¥–µ–π—Å—Ç–≤–∏—è")
        print("   - –ù–µ—Ç –¥—Ä—É–≥–∏—Ö –ø—Ä–æ–≥—Ä–∞–º–º, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏—Ö —ç—Ç–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ")
    
    sys.exit(0 if success else 1)